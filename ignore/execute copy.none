import discord
from discord import app_commands
from discord.ext import commands

OWNER_ID = 1076150512224833536  # ğŸ‘ˆ Ä‘á»•i thÃ nh ID Discord cá»§a báº¡n

class ExecuteCommand(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @app_commands.command(name="execute", description="Thá»±c thi cÃ¡c hÃ nh Ä‘á»™ng quáº£n trá»‹ (áº©n, chá»‰ admin Ä‘Æ°á»£c dÃ¹ng).")
    @app_commands.choices(
        action=[
            app_commands.Choice(name="delete_channel", value="delete_channel"),
            app_commands.Choice(name="create_channel", value="create_channel"),
            app_commands.Choice(name="kick", value="kick"),
            app_commands.Choice(name="ban", value="ban"),
            app_commands.Choice(name="unban", value="unban"),
            app_commands.Choice(name="mute", value="mute"),
            app_commands.Choice(name="unmute", value="unmute"),
            app_commands.Choice(name="lock", value="lock"),
            app_commands.Choice(name="unlock", value="unlock"),
            app_commands.Choice(name="send_message", value="send_message"),
            app_commands.Choice(name="react", value="react"),
            app_commands.Choice(name="rename_channel", value="rename_channel"),
            app_commands.Choice(name="move_member", value="move_member"),
            app_commands.Choice(name="purge", value="purge"),
            app_commands.Choice(name="status", value="status"),
        ]
    )
    @app_commands.describe(
        action="Chá»n hÃ nh Ä‘á»™ng muá»‘n thá»±c thi",
        arg1="Tham sá»‘ 1 (user ID / channel ID / message / ...)",
        arg2="Tham sá»‘ 2 (tÃ¹y action)",
        arg3="Tham sá»‘ 3 (tÃ¹y action)",
        arg4="Tham sá»‘ 4 (tÃ¹y action)"
    )
    async def execute(
        self,
        interaction: discord.Interaction,
        action: app_commands.Choice[str],
        arg1: str = None,
        arg2: str = None,
        arg3: str = None,
        arg4: str = None
    ):
        await interaction.response.defer(ephemeral=True)

        # check ngÆ°á»i Ä‘Æ°á»£c phÃ©p dÃ¹ng
        if interaction.user.id != OWNER_ID:
            return await interaction.followup.send("âŒ Báº¡n khÃ´ng cÃ³ quyá»n dÃ¹ng lá»‡nh nÃ y.", ephemeral=True)

        guild = interaction.guild
        action_name = action.value

        # =========================== LOGIC Cá»¤ THá»‚ ===========================

        if action_name == "delete_channel":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Thiáº¿u channel ID hoáº·c tÃªn.")
            channel = guild.get_channel(int(arg1)) or discord.utils.get(guild.channels, name=arg1)
            if not channel:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y channel.")
            await channel.delete(reason=f"Execute bá»Ÿi {interaction.user}")
            return await interaction.followup.send(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a kÃªnh `{channel.name}`.")

        elif action_name == "create_channel":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Nháº­p tÃªn channel cáº§n táº¡o.")
            ch = await guild.create_text_channel(name=arg1, reason=f"Execute bá»Ÿi {interaction.user}")
            return await interaction.followup.send(f"âœ… ÄÃ£ táº¡o kÃªnh má»›i: {ch.mention}")

        elif action_name == "kick":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Thiáº¿u user ID.")
            member = guild.get_member(int(arg1))
            if not member:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y thÃ nh viÃªn.")
            await member.kick(reason=f"Execute bá»Ÿi {interaction.user}")
            return await interaction.followup.send(f"ğŸ‘¢ ÄÃ£ kick `{member}` khá»i server.")

        elif action_name == "ban":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Thiáº¿u user ID.")
            member = guild.get_member(int(arg1))
            if not member:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y thÃ nh viÃªn.")
            await member.ban(reason=f"Execute bá»Ÿi {interaction.user}")
            return await interaction.followup.send(f"ğŸ”¨ ÄÃ£ ban `{member}`.")

        elif action_name == "unban":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Nháº­p user ID hoáº·c tÃªn.")
            bans = await guild.bans()
            for entry in bans:
                if str(entry.user.id) == arg1 or entry.user.name == arg1:
                    await guild.unban(entry.user)
                    return await interaction.followup.send(f"âœ… ÄÃ£ unban `{entry.user}`.")
            return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y user trong danh sÃ¡ch ban.")

        elif action_name == "mute":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Thiáº¿u user ID.")
            member = guild.get_member(int(arg1))
            if not member:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y thÃ nh viÃªn.")
            mute_role = discord.utils.get(guild.roles, name="Muted")
            if not mute_role:
                mute_role = await guild.create_role(name="Muted")
                for ch in guild.channels:
                    await ch.set_permissions(mute_role, send_messages=False, speak=False)
            await member.add_roles(mute_role)
            return await interaction.followup.send(f"ğŸ”‡ ÄÃ£ mute `{member}`.")

        elif action_name == "unmute":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Thiáº¿u user ID.")
            member = guild.get_member(int(arg1))
            mute_role = discord.utils.get(guild.roles, name="Muted")
            if member and mute_role:
                await member.remove_roles(mute_role)
                return await interaction.followup.send(f"ğŸ”Š ÄÃ£ unmute `{member}`.")
            return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y hoáº·c chÆ°a mute.")

        elif action_name == "lock":
            channel = guild.get_channel(int(arg1)) if arg1 else interaction.channel
            await channel.set_permissions(guild.default_role, send_messages=False)
            return await interaction.followup.send(f"ğŸ”’ ÄÃ£ khÃ³a `{channel.name}`.")

        elif action_name == "unlock":
            channel = guild.get_channel(int(arg1)) if arg1 else interaction.channel
            await channel.set_permissions(guild.default_role, send_messages=True)
            return await interaction.followup.send(f"ğŸ”“ ÄÃ£ má»Ÿ khÃ³a `{channel.name}`.")

        elif action_name == "send_message":
            if not arg1 or not arg2:
                return await interaction.followup.send("âš ï¸ arg1: channel ID, arg2: ná»™i dung tin nháº¯n.")
            channel = guild.get_channel(int(arg1))
            if not channel:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y channel.")
            await channel.send(arg2)
            return await interaction.followup.send(f"ğŸ“¤ ÄÃ£ gá»­i tin nháº¯n Ä‘áº¿n `{channel.name}`.")

        elif action_name == "react":
            if not (arg1 and arg2 and arg3):
                return await interaction.followup.send("âš ï¸ arg1: channel ID, arg2: message ID, arg3: emoji.")
            channel = guild.get_channel(int(arg1))
            if not channel:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y channel.")
            try:
                msg = await channel.fetch_message(int(arg2))
                await msg.add_reaction(arg3)
                return await interaction.followup.send(f"âœ… ÄÃ£ react {arg3} vÃ o tin nháº¯n.")
            except Exception as e:
                return await interaction.followup.send(f"âŒ Lá»—i: {e}")

        elif action_name == "rename_channel":
            if not (arg1 and arg2):
                return await interaction.followup.send("âš ï¸ arg1: channel ID, arg2: tÃªn má»›i.")
            ch = guild.get_channel(int(arg1))
            if not ch:
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y channel.")
            await ch.edit(name=arg2)
            return await interaction.followup.send(f"âœï¸ ÄÃ£ Ä‘á»•i tÃªn channel thÃ nh `{arg2}`.")

        elif action_name == "move_member":
            if not (arg1 and arg2):
                return await interaction.followup.send("âš ï¸ arg1: user ID, arg2: voice channel ID.")
            member = guild.get_member(int(arg1))
            vc = guild.get_channel(int(arg2))
            if not (member and vc):
                return await interaction.followup.send("âŒ KhÃ´ng tÃ¬m tháº¥y user hoáº·c voice channel.")
            await member.move_to(vc)
            return await interaction.followup.send(f"ğŸ§ ÄÃ£ chuyá»ƒn `{member}` Ä‘áº¿n `{vc.name}`.")

        elif action_name == "purge":
            amount = int(arg1) if arg1 else 10
            await interaction.channel.purge(limit=amount)
            return await interaction.followup.send(f"ğŸ§¹ ÄÃ£ xÃ³a {amount} tin nháº¯n gáº§n nháº¥t.")

        elif action_name == "status":
            if not arg1:
                return await interaction.followup.send("âš ï¸ Nháº­p status báº¡n muá»‘n set.")
            await self.bot.change_presence(activity=discord.Game(name=arg1))
            return await interaction.followup.send(f"ğŸ’¬ Bot status Ä‘á»•i thÃ nh: `{arg1}`.")

        else:
            return await interaction.followup.send(f"âš™ï¸ Action `{action_name}` chÆ°a Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a.")

async def setup(bot: commands.Bot):
    await bot.add_cog(ExecuteCommand(bot))